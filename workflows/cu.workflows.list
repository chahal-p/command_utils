#!/usr/bin/env bash

table=( -- "Name" "Next Scheduled" "$(printf "%s\n %s" "Recurring Interval" "(seconds)")" )

user="$(whoami)"

for name in $(_cu.persistent_kv list _cu_workflows_${user} 2>/dev/null); do
  table+=(--)
  table+=("${name}")
  scheduled=$(_cu.persistent_kv get _cu_workflows_scheduled_${user} "${name}" 2>/dev/null)
  code=$?
  [ $code -eq 0 ] && [[ ${scheduled} -le $(date +%s%N) ]] && scheduled="Now"
  [ $code -eq 0 ] || scheduled="-"

  [ "${scheduled}" != "-" ] && [ "${scheduled}" != "Now" ] && scheduled=$(cu.date.from-epoch --seconds "$((${scheduled} / 1000000000))")
  table+=("${scheduled}")
  interval=$(_cu.persistent_kv get _cu_workflows_intervals_${user} "${name}" 2>/dev/null)
  code=$?
  [ $code -eq 0 ] || interval="-"
  table+=("${interval}")
done

cu.generate_table "${table[@]}"