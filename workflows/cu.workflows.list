#!/usr/bin/env bash

NAMESPACE_PREFIX="_cu_workflows"

table=( -- "Name" "Next Scheduled" "$(printf "%s\n %s" "Recurring Interval" "(seconds)")" )

user="$(whoami)"

for name in $(_cu.persistent_kv list ${NAMESPACE_PREFIX}_${user} 2>/dev/null); do
  table+=(--)
  table+=("${name}")
  scheduled=$(_cu.persistent_kv get ${NAMESPACE_PREFIX}_scheduled_${user} "${name}" 2>/dev/null)
  code=$?
  [ $code -eq 0 ] && [[ ${scheduled} -le $(cu.date.to-epoch --out_nanoseconds) ]] && scheduled="Now"
  [ $code -eq 0 ] || scheduled="-"

  [ "${scheduled}" != "-" ] && [ "${scheduled}" != "Now" ] && scheduled=$(cu.date.from-epoch --seconds "$((${scheduled} / 1000000000))")
  table+=("${scheduled}")
  interval=$(_cu.persistent_kv get ${NAMESPACE_PREFIX}_intervals_${user} "${name}" 2>/dev/null)
  code=$?
  [ $code -eq 0 ] || interval="-"
  table+=("${interval}")
done

cu.generate_table "${table[@]}"