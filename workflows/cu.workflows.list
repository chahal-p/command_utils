#!/usr/bin/env bash

table=( -- "Name" "Next Scheduled" "$(printf "%s\n %s" "Recurring Interval" "(seconds)")" )

for name in $(_cu.persistent_kv list _cu_workflows); do
  table+=(--)
  table+=("${name}")
  scheduled=$(_cu.persistent_kv get _cu_workflows_scheduled "${name}" 2>/dev/null)
  code=$?
  [ $code -eq 0 ] && [[ ${scheduled%.*} -le $(date +%s) ]] && scheduled="Now"
  [ $code -eq 0 ] || scheduled="-"

  [ "${scheduled}" != "-" ] && [ "${scheduled}" != "Now" ] && scheduled=$(date -d "@${scheduled}" +%Y-%m-%dT%H:%M:%S%z)
  table+=("${scheduled}")
  interval=$(_cu.persistent_kv get _cu_workflows_intervals "${name}" 2>/dev/null)
  code=$?
  [ $code -eq 0 ] || interval="-"
  table+=("${interval}")
done

cu.generate_table "${table[@]}"